image: ruby:2.3-alpine

services:

variables:
  GIT_STRATEGY: clone

cache:
  key: "$CI_BUILD_REF_NAME"
  untracked: true
  paths:
    - vendor/ruby

before_script:
  - cp .env-example .env
  - source .env
  - export DEBIAN_FRONTEND=noninteractive
  - apk update
  - apk add --update alpine-sdk
  - ruby -v

after_script:
  - ./scripts/notify_hipchat.sh

stages:
  - spec
  - check
  - audit
  - deploy
  - pages
  - cleanup

dev_spec_puppet:
  only:
    - branches
  except:
    - master
  stage: spec
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install --path vendor
    - bundle exec rake compute_dev_version
    - bundle exec rake clean
    - bundle exec rake spec_clean
    - bundle exec rake spec_prep
  tags:
    - ruby
    - puppet

dev_rubocop:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake compute_dev_version
  - bundle exec rake rubocop
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_dot_underscore:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake compute_dev_version
  - bundle exec rake check:dot_underscore
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_git_ignore:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake compute_dev_version
  - bundle exec rake check:git_ignore
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_test_file:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake compute_dev_version
  - bundle exec rake check:test_file
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_symlinks:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake compute_dev_version
  - bundle exec rake check:symlinks
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_release_checks:
  only:
  - branches
  except:
  - master
  stage: check
  script:
  - gem install bundler  --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake release_checks
  dependencies:
  - dev_spec_puppet
  tags:
  - ruby
  - puppet

dev_audit:
  only:
  - branches
  except:
  - master
  stage: audit
  script:
  - gem install bundler  --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - 'bundle exec rake bundle:audit'
  dependencies:
  - dev_rubocop
  - dev_dot_underscore
  - dev_git_ignore
  - dev_test_file
  - dev_symlinks
  - dev_release_checks
  tags:
  - ruby
  - puppet

dev_build_puppet_module:
  only:
    - branches
  except:
    - master
  stage: deploy
  before_script:
  - apt-get update
  - apt-get -qq install python python-pip ca-certificates
  - pip install awscli
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake build
    - aws s3 sync pkg/ s3://$S3_BUCKET
  dependencies:
  - dev_audit
  artifacts:
    paths:
    - pkg/
  tags:
    - ruby
    - puppet
  environment: development

# MASTER branch goes to production and triggers puppet pull
# MASTER Tests
release_checks:
  only:
    - master
  stage: spec
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake spec_prep
    - bundle exec rake release_checks
  tags:
    - ruby
    - puppet

dot_underscore:
  only:
    - master
  stage: check
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake spec_prep
    - 'bundle exec rake check:dot_underscore'
  dependencies:
  - release_checks
  tags:
    - ruby
    - puppet

git_ignore:
  only:
    - master
  stage: check
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake spec_prep
    - 'bundle exec rake check:git_ignore'
  dependencies:
  - release_checks
  tags:
    - ruby
    - puppet

test_file:
  only:
    - master
  stage: check
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake spec_prep
    - 'bundle exec rake check:test_file'
  dependencies:
  - release_checks
  tags:
    - ruby
    - puppet

check_symlinks:
  only:
    - master
  stage: check
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - 'bundle exec rake check:symlinks'
  dependencies:
  - release_checks
  tags:
    - ruby
    - puppet

audit:
  only:
    - master
  stage: audit
  script:
    - gem install bundler  --no-ri --no-rdoc
    - bundle install -j $(nproc) --path vendor
    - bundle exec rake spec_prep
    - 'bundle exec rake bundle:audit'
  dependencies:
  - dot_underscore
  - git_ignore
  - test_file
  - check_symlinks
  tags:
    - ruby
    - puppet

puppet_module:
  only:
    - master
  stage: deploy
  before_script:
  - apt-get update
  - apt-get -qq install python python-pip ca-certificates
  - pip install awscli
  script:
  - gem install bundler  --no-ri --no-rdoc
  - bundle install -j $(nproc) --path vendor
  - bundle exec rake build
  - aws s3 sync pkg/ s3://$S3_BUCKET
  dependencies:
  - audit
  artifacts:
    paths:
    - pkg/
  tags:
    - ruby
    - puppet
  environment: production
